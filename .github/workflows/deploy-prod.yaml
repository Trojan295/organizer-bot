on:
  push:
    branches:
      - "main"

jobs:
  build-docker:
    name: Build Docker image
    runs-on: ubuntu-latest
    env:
      SCW_ACCESS_KEY: ${{ secrets.SCW_ACCESS_KEY }}
      SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Build image
        run: |
          ./hack/docker.sh build
      - name: Push image
        run: |
          ./hack/docker.sh push

  deploy-bot :
    name: Deploy bot
    runs-on: ubuntu-latest
    needs: [build-docker]
    env:
      SCW_ACCESS_KEY: ${{ secrets.SCW_ACCESS_KEY }}
      SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
      SCW_DEFAULT_ORGANIZATION_ID: "84d05136-a8ba-43e7-8c6b-abac62b87873"
      SCW_K8S_CLUSTER_ID: "c03db9bf-3809-4fff-bcda-f513dc5042b6"
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Install scw
        run: |
          sudo curl -o /usr/local/bin/scw -L "https://github.com/scaleway/scaleway-cli/releases/download/v2.3.1/scw-2.3.1-linux-x86_64"
          sudo chmod +x /usr/local/bin/scw
      - name: Configure kubeconfig
        run: |
          mkdir -p "$HOME/.kube"
          scw k8s kubeconfig get "${SCW_K8S_CLUSTER_ID}" > "$HOME/.kube/config"
          chmod 400 $HOME/.kube/config
      - name: Deploy Helm release
        run: |
          ./hack/deploy.sh
